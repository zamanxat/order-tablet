<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Larossa Logistics | Smart Search</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="shortcut icon" href="https://i.ibb.co.com/hFhh091B/logo.jpg" type="image/x-icon">
    <style>
        :root {
            --bg: #f1f5f9;
            --white: #ffffff;
            --primary: #0f172a;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --card-radius: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 15px;
            padding-bottom: 100px;
            color: var(--primary);
        }

        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(241, 245, 249, 0.95);
            backdrop-filter: blur(12px);
            margin: -15px -15px 15px -15px; padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-box {
            position: relative; margin-bottom: 12px;
        }

        .search-box input {
            width: 100%; padding: 14px 14px 14px 45px;
            border: 2px solid #e2e8f0; border-radius: 15px;
            font-size: 16px; outline: none; box-sizing: border-box;
            transition: 0.3s;
        }

        .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }

        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filters { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; scrollbar-width: none; }
        .filters::-webkit-scrollbar { display: none; }
        
        .chip {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px;
            background: var(--white); border: 1px solid #e2e8f0;
            font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .date-range-picker {
            display: none; gap: 8px; align-items: center; 
            background: #fff; padding: 10px; border-radius: 12px;
            margin-top: 5px; border: 1px solid #e2e8f0;
        }
        .date-range-picker input { border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px; font-size: 12px; }

        .card {
            background: var(--white); border-radius: var(--card-radius);
            padding: 18px; margin-bottom: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(226, 232, 240, 0.8);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-title { font-size: 17px; font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; }

        .contact-bar {
            background: #f8fafc; padding: 10px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; text-decoration: none; border: 1px solid #f1f5f9;
        }

        .phone-num { font-size: 16px; font-weight: 700; color: var(--accent); }
        .call-icon { width: 35px; height: 35px; background: var(--success); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; }

        .info-item { display: flex; gap: 10px; margin-bottom: 10px; }
        .info-item i { color: var(--danger); font-size: 16px; width: 18px; text-align: center; }
        .info-text { font-size: 14px; font-weight: 500; color: #475569; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-action { padding: 10px; border-radius: 10px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-2gis { background: #eef2ff; color: #4338ca; }
        .btn-copy { background: #f1f5f9; color: #475569; }

        .cargo-tag { background: #f8fafc; border-radius: 12px; padding: 10px; border-left: 4px solid var(--accent); margin-bottom: 15px; }
        .cargo-name { font-weight: 700; font-size: 14px; color: var(--primary); }

        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-weight: 600; font-size: 13px; background: white; outline: none; }

        .fab { position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="mainSearch" placeholder="–ê—Ç—ã, –Ω–æ–º–µ—Ä (8777...), —Ç–∞—É–∞—Ä, –∞–¥—Ä–µ—Å..." oninput="filter()">
        </div>

        <div class="filter-group">
            <div class="filters" id="timeFilters">
                <button class="chip active" onclick="applyTimeFilter('–ë–∞—Ä–ª—ã“ì—ã', this)">–ë–∞—Ä–ª—ã“ì—ã</button>
                <button class="chip" onclick="applyTimeFilter('–ë“Ø–≥—ñ–Ω', this)">–ë“Ø–≥—ñ–Ω</button>
                <button class="chip" onclick="applyTimeFilter('–ê–ø—Ç–∞', this)">–ê–ø—Ç–∞</button>
                <button class="chip" onclick="applyTimeFilter('–ê–π', this)">–ê–π</button>
                <button class="chip" onclick="applyTimeFilter('–ê—Ä–∞–ª—ã“õ', this)">üìÖ –ê—Ä–∞–ª—ã“õ</button>
            </div>

            <div class="date-range-picker" id="customDatePanel">
                <input type="date" id="dateStart" onchange="filter()">
                <span>-</span>
                <input type="date" id="dateEnd" onchange="filter()">
            </div>

            <div class="filters" id="statusFilters">
                <button class="chip active" onclick="applyStatusFilter('all', this)">–ë–∞—Ä–ª—ã“ì—ã</button>
                <button class="chip" onclick="applyStatusFilter('–ñ–∞“£–∞', this)">‚è≥ –ñ–∞“£–∞</button>
                <button class="chip" onclick="applyStatusFilter('–ü—Ä–æ—Ü–µ—Å—Ç–µ', this)">üîÑ –ü—Ä–æ—Ü–µ—Å—Ç–µ</button>
                <button class="chip" onclick="applyStatusFilter('–ñ–æ–ª–¥–∞', this)">üöö –ñ–æ–ª–¥–∞</button>
                <button class="chip" onclick="applyStatusFilter('“ö–∞–±—ã–ª–¥–∞–Ω–¥—ã', this)">‚úÖ –ñ–µ—Ç—Ç—ñ</button>
            </div>
        </div>
    </div>

    <div id="container"></div>

    <button class="fab" onclick="load()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script>
        const SB_URL = 'https://jnuokhhqojlurvadcduv.supabase.co';
        const SB_KEY = 'sb_publishable_3l9NjY0Qadv3dJ9x3-t19w_8mKniZBk'; 
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let store = [];
        let currentStatus = 'all';
        let currentTimeScope = '–ë–∞—Ä–ª—ã“ì—ã';

        async function load() {
            document.getElementById('container').innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>';
            const { data, error } = await supabaseClient.from('orders').select('*').order('created_at', { ascending: false });
            if (!error) {
                store = (data || []).map(o => ({
                    ...o,
                    status: (o.status === null || o.status === "" || o.status === "null") ? "–ñ–∞“£–∞" : o.status
                }));
                filter();
            }
        }

        function applyStatusFilter(status, el) {
            currentStatus = status;
            document.querySelectorAll('#statusFilters .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            filter();
        }

        function applyTimeFilter(scope, el) {
            currentTimeScope = scope;
            document.querySelectorAll('#timeFilters .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('customDatePanel').style.display = (scope === '–ê—Ä–∞–ª—ã“õ') ? 'flex' : 'none';
            filter();
        }

        function filter() {
            const val = document.getElementById('mainSearch').value.toLowerCase().trim();
            // –Ü–∑–¥–µ—É –∂–æ–ª–∞“ì—ã–Ω–¥–∞“ì—ã –Ω”©–º—ñ—Ä–¥–µ–Ω –±–∞—Ä–ª—ã“õ —Ç–∞“£–±–∞–ª–∞—Ä–¥—ã –∞–ª—ã–ø —Ç–∞—Å—Ç–∞–ø, —Ç–µ–∫ —Å–∞–Ω–¥–∞—Ä–¥—ã “õ–∞–ª–¥—ã—Ä—É (–º—ã—Å–∞–ª—ã: 8 (777) 123 -> 8777123)
            const cleanSearchVal = val.replace(/\D/g, ''); 

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const dayOfWeek = now.getDay();
            const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const startOfWeek = new Date(startOfToday);
            startOfWeek.setDate(startOfToday.getDate() - diffToMonday);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const filtered = store.filter(o => {
                const orderDate = new Date(o.created_at);
                
                // --- –°–ú–ê–†–¢ –Ü–ó–î–ï–£ –õ–û–ì–ò–ö–ê–°–´ ---
                // –ö–ª–∏–µ–Ω—Ç –Ω”©–º—ñ—Ä—ñ–Ω –¥–µ —Ç–∞–∑–∞–ª–∞–ø –∞–ª–∞–º—ã–∑ (—Ç–µ–∫ —Å–∞–Ω–¥–∞—Ä)
                const cleanPhone = (o.client_phone || '').replace(/\D/g, '');
                
                const searchMatch = !val || (
                    (o.client_name?.toLowerCase().includes(val)) || 
                    (o.address?.toLowerCase().includes(val)) ||
                    (o.product?.toLowerCase().includes(val)) ||
                    (o.gift?.toLowerCase().includes(val)) ||
                    // –ï–≥–µ—Ä —Ç–∞–∑–∞–ª–∞–Ω“ì–∞–Ω —ñ–∑–¥–µ—É –º”ô–Ω—ñ –Ω”©–º—ñ—Ä–¥—ñ“£ —ñ—à—ñ–Ω–¥–µ –±–æ–ª—Å–∞
                    (cleanPhone.includes(cleanSearchVal) && cleanSearchVal !== '') ||
                    // –ù–µ–º–µ—Å–µ –∂–∞–π “ì–∞–Ω–∞ —Ç–µ–∫—Å—Ç —Ä–µ—Ç—ñ–Ω–¥–µ –¥–µ —ñ–∑–¥–µ–π –±–µ—Ä–µ–¥—ñ
                    (o.client_phone?.includes(val))
                );
                
                // --- –£–ê“ö–´–¢ –ñ”ò–ù–ï –°–¢–ê–¢–£–° ---
                const statusMatch = (currentStatus === 'all') || (o.status === currentStatus);
                
                let timeMatch = true;
                if (currentTimeScope === '–ë“Ø–≥—ñ–Ω') timeMatch = orderDate >= startOfToday;
                else if (currentTimeScope === '–ê–ø—Ç–∞') timeMatch = orderDate >= startOfWeek;
                else if (currentTimeScope === '–ê–π') timeMatch = orderDate >= startOfMonth;
                else if (currentTimeScope === '–ê—Ä–∞–ª—ã“õ') {
                    const s = document.getElementById('dateStart').value;
                    const e = document.getElementById('dateEnd').value;
                    if (s) timeMatch = timeMatch && (orderDate >= new Date(s));
                    if (e) {
                        const endLimit = new Date(e);
                        endLimit.setHours(23, 59, 59);
                        timeMatch = timeMatch && (orderDate <= endLimit);
                    }
                }

                return searchMatch && statusMatch && timeMatch;
            });
            render(filtered);
        }

        function render(list) {
            const container = document.getElementById('container');
            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">–¢–∞–ø—Å—ã—Ä—ã—Å —Ç–∞–±—ã–ª–º–∞–¥—ã üîç</div>';
                return;
            }

            container.innerHTML = list.map(o => `
                <div class="card">
                    <div class="card-title">
                        <span style="max-width: 70%;">${o.client_name || '–ê—Ç—ã –∂–æ“õ'}</span>
                        <div style="text-align: right;">
                            <div style="font-size:11px; color:var(--accent); font-weight:800;">#${o.id.toString().slice(-4)}</div>
                            <small style="font-size:10px; color:#94a3b8">${new Date(o.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <a href="tel:${o.client_phone}" class="contact-bar">
                        <span class="phone-num">${o.client_phone || '‚Äî'}</span>
                        <div class="call-icon"><i class="fas fa-phone"></i></div>
                    </a>
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="info-text" id="addr_${o.id}">${o.address || '‚Äî'}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn-action btn-copy" onclick="copy('addr_${o.id}', this)">–ö”©—à—ñ—Ä—É</button>
                        <a href="https://2gis.kz/search/${encodeURIComponent(o.address)}" target="_blank" class="btn-action btn-2gis" style="text-decoration:none">2GIS</a>
                    </div>
                    <div class="cargo-tag">
                        <div class="cargo-name">üì¶ ${o.product || '‚Äî'}</div>
                        ${o.gift ? `<div style="color:var(--danger); font-size:11px; margin-top:5px; font-weight:700;">üéÅ ${o.gift}</div>` : ''}
                    </div>
                    <div class="status-grid">
                        <select onchange="update('${o.id}', 'delivery_type', this.value)">
                            <option value="–ö—É—Ä—å–µ—Ä" ${o.delivery_type === '–ö—É—Ä—å–µ—Ä' ? 'selected' : ''}>üõµ –ö—É—Ä—å–µ—Ä</option>
                            <option value="–¢–∞–∫—Å–∏" ${o.delivery_type === '–¢–∞–∫—Å–∏' ? 'selected' : ''}>üöï –¢–∞–∫—Å–∏</option>
                            <option value="–ü–æ–µ–∑–¥" ${o.delivery_type === '–ü–æ–µ–∑–¥' ? 'selected' : ''}>üöÇ –ü–æ–µ–∑–¥</option>
                            <option value="–ü–æ—á—Ç–∞" ${o.delivery_type === '–ü–æ—á—Ç–∞' ? 'selected' : ''}>üì¶ –ü–æ—á—Ç–∞</option>
                        </select>
                        <select onchange="update('${o.id}', 'status', this.value)" 
                                style="background: ${o.status==='“ö–∞–±—ã–ª–¥–∞–Ω–¥—ã'?'#dcfce7':o.status==='–ñ–æ–ª–¥–∞'?'#dbeafe':o.status==='–ü—Ä–æ—Ü–µ—Å—Ç–µ'?'#fffbeb':'white'};
                                       color: ${o.status==='“ö–∞–±—ã–ª–¥–∞–Ω–¥—ã'?'#166534':o.status==='–ñ–æ–ª–¥–∞'?'#1e40af':o.status==='–ü—Ä–æ—Ü–µ—Å—Ç–µ'?'#b45309':'#0f172a'}">
                            <option value="–ñ–∞“£–∞" ${o.status === '–ñ–∞“£–∞' ? 'selected' : ''}>‚è≥ –ñ–∞“£–∞</option>
                            <option value="–ü—Ä–æ—Ü–µ—Å—Ç–µ" ${o.status === '–ü—Ä–æ—Ü–µ—Å—Ç–µ' ? 'selected' : ''}>üîÑ –ü—Ä–æ—Ü–µ—Å—Ç–µ</option>
                            <option value="–ñ–æ–ª–¥–∞" ${o.status === '–ñ–æ–ª–¥–∞' ? 'selected' : ''}>üöö –ñ–æ–ª–¥–∞</option>
                            <option value="“ö–∞–±—ã–ª–¥–∞–Ω–¥—ã" ${o.status === '“ö–∞–±—ã–ª–¥–∞–Ω–¥—ã' ? 'selected' : ''}>‚úÖ –ñ–µ—Ç—Ç—ñ</option>
                            <option value="“ö–∞–π—Ç–∞—Ä—ã–ª–¥—ã" ${o.status === '“ö–∞–π—Ç–∞—Ä—ã–ª–¥—ã' ? 'selected' : ''}>‚ùå “ö–∞–π—Ç—Ç—ã</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        async function update(id, field, val) {
            const { error } = await supabaseClient.from('orders').update({ [field]: val }).eq('id', id);
            if (!error) {
                const item = store.find(o => o.id == id);
                if (item) { item[field] = val; filter(); }
            }
        }

        function copy(elementId, btn) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text);
            const old = btn.innerText;
            btn.innerText = '‚úÖ –ö”©—à—ñ—Ä—ñ–ª–¥—ñ';
            setTimeout(() => btn.innerText = old, 1500);
        }

        load();
    </script>
</body>
</html>
